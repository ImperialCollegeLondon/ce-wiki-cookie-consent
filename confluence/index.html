<script>
(function(){

// fun JS hack to only include external files once
function addElementToHeadOnce(d, e) {
    if (d.getElementById(e.id) == null) {
        d.getElementsByTagName('head')[0].appendChild(e);
    } else {
        console.warn(`element with matching ID ${e.id} already exists in DOM`,e);
    }
}

// load MathJax
(function(d, e) {
    e = d.createElement('script');
    e.async = true;
    e.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_HTMLorMML';
    e.id = 'ce-wiki-mathjax-js';
    addElementToHeadOnce(d, e);
})(document);

// Global site tag (gtag.js) - Google Analytics
(function(d, e) {
    e = d.createElement('script');
    e.async = true;
    e.src = 'https://www.googletagmanager.com/gtag/js?id=UA-172324691-1';
    e.id = 'ce-wiki-gtag-js';
    addElementToHeadOnce(d, e);
})(document);

// GA configuration
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

// Set default consent for ad and analytics storage.
gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied',
    'wait_for_update': 500  // milliseconds, gives Osano time to load https://developers.google.com/gtagjs/devguide/consent#asynchronous_tools
});
// Use fallback when analytics_storage still denied https://developers.google.com/gtagjs/devguide/consent#url_passthrough
gtag('set', 'url_passthrough', true);
// Prevent analytics data from being used for ads personalisation
// https://developers.google.com/analytics/devguides/collection/ga4/display-features#disable_advertising_personalization
gtag('set', 'allow_ad_personalization_signals', false);

// Now load GA
gtag('js', new Date());
// configuration to apply to both properties
gtag('set', {
    // restrict GA to our own cookies (don't use any set on the main Imperial site)
    'cookie_prefix': 'ce_wiki',
    'cookie_domain': 'wiki.imperial.ac.uk'
});

// User ID
digestMessage(AJS.Meta.get("remote-user")).then(function(result){
    gtag('set', {'user_id': result}); // use gtag set so that it propagates to the connected GA4 tag too 
});

// send hit to Universal Analytics property
gtag('config', 'UA-172324691-1', {
    'anonymize_ip': true // required for GDPR compliance when tracking without user consent
});
// send hit to GA4 (new version) property
// this is automatically done via a connection from the tag above
// IP address is automatically anonymised for GA4

// load Osano
(function(d, e) {
    e = d.createElement('script');
    e.async = true;
    e.src = 'https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js';
    e.id = 'ce-wiki-osano-js';
    addElementToHeadOnce(d, e);
})(document);

// adjust Osano settings
// https://www.osano.com/cookieconsent/documentation/javascript-api/
window.cookieconsent.initialise({
    content: {
        message: "We use optional third-party analytics cookies to better understand how you use this site.",
        allow: "Accept"
    },
    position: "bottom-right",
    palette: {
        popup: {
            background: "#ebeeee",
            text: "#161515"
        },
        button: {
            background: "#003e74",
            text: "#fff"
        }
    },
    type: "opt-in",
    law: "GB",
    revokable: "true",
    cookie: {
        name: "ce_wiki_cookieconsent",
        domain: "wiki.imperial.ac.uk"
    },
    // https://www.osano.com/cookieconsent/documentation/disabling-cookies/
    onInitialise: function (status) {
        var type = this.options.type;
        var didConsent = this.hasConsented();
        console.log(didConsent ? 'enable cookies' : 'disable cookies');
        if (type == 'opt-in' && didConsent) {
            gtag('consent', 'update', {'analytics_storage': 'granted'});
        }
        if (type == 'opt-out' && !didConsent) {
            gtag('consent', 'update', {'analytics_storage': 'denied'});
        }
    },
    onStatusChange: function(status) {
        var type = this.options.type;
        var didConsent = this.hasConsented();
        console.log(didConsent ? 'enable cookies' : 'disable cookies');
        if (type == 'opt-in' && didConsent) {
            gtag('consent', 'update', {'analytics_storage': 'granted'});
        }
        if (type == 'opt-out' && !didConsent) {
            gtag('consent', 'update', {'analytics_storage': 'denied'});
        }
    },
    onRevokeChoice: function() {
        var type = this.options.type;
        if (type == 'opt-in') {
            gtag('consent', 'update', {'analytics_storage': 'denied'});
        }
        if (type == 'opt-out') {
            gtag('consent', 'update', {'analytics_storage': 'granted'});
        }
    }
});

// GA extensions
async function getUserCohortYear() {
    const userSuffix = AJS.Meta.get("remote-user").slice(-2);
    if (/^\d{2}$/.test(userSuffix)) {
        gtag('set', 'user_properties', {
            cohort_year: userSuffix
        });
    }
}
getUserCohortYear();

async function getWikiSpaceKey() {
    if (spaceKey = AJS.Meta.get("space-key")) {
        gtag('event', 'page_view', {
            'wiki_space_key': spaceKey
        });
    }
}
// getWikiSpaceKey();

async function digestMessage(message) {
    const msgUint8 = new TextEncoder().encode(message); // encode as (utf-8) Uint8Array
    const hashBuffer = await crypto.subtle.digest('SHA-512', msgUint8); // hash the message
    const hashArray = Array.from(new Uint8Array(hashBuffer)); // convert buffer to byte array
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); // convert bytes to hex string
    return hashHex;
}

// load Osano CSS
(function(d, e) {
    e = d.createElement('link');
    e.rel = 'stylesheet';
    e.type = 'text/css';
    e.href = 'https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css';
    e.id = 'ce-wiki-osano-css';
    addElementToHeadOnce(d, e);
})(document);

})();
</script>
<style>
    .cc-revoke, .cc-window {
        font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;
    }
</style>
